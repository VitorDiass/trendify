const http=require("http"),https=require("https"),urlParse=require("url").parse,PassThrough=require("stream").PassThrough,httpLibs={"http:":http,"https:":https},redirectCodes={301:!0,302:!0,303:!0,307:!0},defaults={maxRedirects:2,maxRetries:2,maxReconnects:0,backoff:{inc:100,max:1e4},highWaterMark:null,transform:null,acceptEncoding:null};module.exports=((e,t,r)=>{"function"==typeof t?(r=t,t={}):t||(t={}),t=Object.assign({},defaults,t);const n=new PassThrough({highWaterMark:t.highWaterMark});let o,s,a,i,c,d=!1,l=0,u=0,h=0,p=!1,m=0,f=0;if(t.headers&&t.headers.Range){let e=/bytes=(\d+)-(\d+)?/.exec(t.headers.Range);e&&(m=parseInt(e[1],10),c=parseInt(e[2],10))}t.acceptEncoding&&(t.headers=Object.assign({"Accept-Encoding":Object.keys(t.acceptEncoding).join(", ")},t.headers));const g=(e,r)=>{if(!d)if(s&&p&&0<f&&f<i){if(h++<t.maxReconnects){s=null,u=0;let r=Math.min(t.backoff.inc,t.backoff.max);return a=setTimeout(b,r),void n.emit("reconnect",h,e)}}else if((!r||"ENOTFOUND"===e.message)&&u++<t.maxRetries){let r=Math.min(u*t.backoff.inc,t.backoff.max);return a=setTimeout(b,r),void n.emit("retry",u,e)}n.emit("error",e)},b=()=>{if(d)return;let r=urlParse(e),a=httpLibs[r.protocol];if(a){Object.assign(r,t);for(let e in defaults)delete r[e];p&&f>0&&(r.headers=Object.assign({},r.headers,{Range:`bytes=${f+m}-${c||""}`})),t.transform&&(r=t.transform(r)).protocol&&(a=httpLibs[r.protocol]),(o=a.get(r,r=>{if(!0===redirectCodes[r.statusCode])return void(l++>=t.maxRedirects?n.emit("error",Error("Too many redirects")):(n.emit("redirect",e=r.headers.location),b()));if(r.statusCode<200||400<=r.statusCode){let e=Error("Status code: "+r.statusCode);return void(r.statusCode>=500?g(e,r.statusCode):n.emit("error",e))}let o=r;if(t.acceptEncoding&&r.headers["content-encoding"])for(let e of r.headers["content-encoding"].split(", ").reverse()){let r=t.acceptEncoding[e];null!=r&&(o=o.pipe(r(o))).on("error",n.emit.bind(n,"error"))}i||(i=parseInt(r.headers["content-length"],10),p="bytes"===r.headers["accept-ranges"]&&i>0&&t.maxReconnects>0),p&&(r.on("data",e=>{f+=e.length}),o.on("end",()=>{f===i&&n.end()})),o.pipe(n,{end:!p}),s=o,n.emit("response",r),r.on("error",n.emit.bind(n,"error"))})).on("error",g),n.emit("request",o)}else n.emit("error",Error("Invalid URL: "+e))};if(n.abort=(()=>{d=!0,n.emit("abort"),o&&o.abort(),s&&s.unpipe(n),clearTimeout(a)}),process.nextTick(b),r){let e="";n.setEncoding("utf8"),n.on("data",t=>{e+=t}),n.on("end",()=>{r(null,s,e)}),n.on("error",r)}return r?null:n});